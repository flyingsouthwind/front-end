## CDN

> ICP，Internet Content Provider，网络内容服务商

内容分发网络，Content delivery/distribution network，缩写 CDN，是指一种透过互联网互相连接的计算机网上系统，利用最靠近用户的服务器，更快、更可靠地将图片、音乐、影片、应用程序及其他文件发送给用户。

**CDN 的实现原理：在原本客户端到服务器这种相对简单的端到端式的网络之间，通过代理域名解析的方式插入一个由分布式存储、负载均衡、网络流量管理和内容管理等子系统构成的完整的计算机网络系统。这个网络系统会在收到用户的请求时，通过对用户位置和网络状况的综合判断，将用户请求引导至距离其最近且网络状况最好的分布式存储的服务器上，从而使用户在最短的时间内获得请求的资源。**

CDN 与传统内容发布模式的区别

* 传统内容发布模式，完全被动的依赖客户端到服务器之间的网络。除提高带宽以外，ICP 提高网络速度的手段十分有限，无法有效地应对局部热点效应等原因引起的短时间大流量的突发状况
* CDN 强调网络在内容发布中的重要性，通过引入主动的内容管理层和全局负载均衡，不仅可以更有效的利用网络，还可以更友好地应对突发的网络拥塞

### 工作原理

首先，看一下未使用 CDN 的传统内容发布模式的工作过程：

![img](./images/0219.png)

1. 用户向浏览器提供要访问的域名
2. 浏览器调用域名解析函数库对域名进行解析，得到域名对应的 IP 地址
3. 浏览器向得到的目标地址服务主机发出数据访问请求
4. 浏览器根据域名主机返回的数据显示网页的内容

使用 CDN 缓存后的内容发布过程：

![img](./images/0220.png)

1. 用户请求指定域名
2. 浏览器调用域名解析库解析域名，由于 CDN 调整了域名解析，所以一般得到的是域名对应的 CNAME 记录
3. 浏览器再次对获得的 CNAME 域名进行解析以得到实际的 IP 地址；**此时，CDN 系统的全局负载均衡 DNS 解析会根据地理位置、网络状态等信息返回最优的 IP 地址，使用户可以就近访问**
4. 浏览器向解析得到的 CDN 缓存服务器的 IP 地址发出请求
5. 缓存服务器，如有缓存则直接返回缓存文件；否则，向源 ICP 服务器提交请求。**所以，是否第一个访问的人获得请求返回反而会很慢？此外，是否 CDN 服务器会同步所有可以同步的 ICP 服务器资源，这样可以保证用户访问时总是有资源的？**
6. 缓存服务器从实际 IP 地址得到内容后，一方面在本地进行保存，以备以后使用；另一方面把获取的数据返回给客户端，完成数据服务过程
7. 客户端得到由缓存服务器返回的数据以后显示出来，并完成整个浏览的数据请求过程

通过以上分析可以得到，为了实现既对普通用户透明（即加入缓存以后用户客户端无需进行任何设置，依旧使用被原有域名进行访问），又要在为网站提供加速服务的同时降低对 ICP 的影响，只需修改整个访问过程中的域名解析即可。下面是 CDN 网络实现的具体操作过程：

1. 作为 ICP，只需要把域名解释权交给 CDN 运营商，其他方面不需进行任何修改；操作时，ICP 修改自己域名的解析记录，一般用 CNAME 方式指向 CDN 网络 Cache 服务器的地址
2. 作为 CDN 运营商，首先需要为 ICP 的域名提供公开解析，为了实现 sortlist，一般是把 ICP 的域名解释结果指向一个 CNAME 记录
3. 当需要进行 sorlist 时，CDN 运营商可以利用 DNS 对 CNAME 指向的域名解析过程进行特殊处理，使 DNS 服务器在接收到客户端请求时可以根据客户端的 IP 地址，返回相同域名的不同 IP 地址
4. 由于从 CNAME 获得的 IP 地址，并且带有 hostname 信息，请求到达 Cache 之后，Cache 必须知道源服务器的 IP 地址，所以在 CDN 运营商内部维护一个内部 DNS 服务器，用于解释用户所访问的域名的真实 IP 地址
5. 在维护内部 DNS 服务器时，还需要维护一台授权服务器，控制哪些域名可以进行缓存，而哪些又不进行缓存，以免发生开放代理的情况

### 技术手段

实现 CDN 的主要技术手段有高速缓存和镜像服务器。

* 高速缓存
  * 优点是成本较低
  * 缺点是仅适用于静态内容。不过，统计表明，超过 80% 的用户经常访问的是 20% 的网站内容，在这个规律下，缓存服务器可以处理大部分客户的静态请求，而原始服务器只需处理约 20% 左右的非缓存请求和动态请求，于是大大加快了客户请求的响应时间，并降低了原始 WWW 服务器的负载
* 镜像站点
  * 优点是分布式的镜像服务器，不仅适用于静态内容同步，也适用于准动态的数据同步
  * 缺点是相较于仅支持高速缓存的服务器而言，购买和维护镜像服务器的费用都较高；此外，大型网站在随时更新各地镜像服务器的同时，对带宽的需求也会显著增加

因此，一般的互联网公司使用高速缓存的可能更高，不会建立太多的镜像服务器。

### 网络架构

CDN 网络架构主要包括中心和边缘两部分：

* 中心，指 CDN 网管中心和 DNS 重定向解析中心，负责全局负载均衡

  用户访问时，DNS 进行域名解析，通过预定义的策略，将最优的节点地址提供给用户；同时，它还与分布在各地的缓存服务器保持通信，以搜集各节点的通信状态，确保不将用户的请求分配到不可用的节点上

* 边缘，主要指异地节点，CDN 分发的载体，主要由负载均衡器和高速缓存服务器等组成

  * 负载均衡设备，负责节点自己的缓存负载均衡，保证节点的工作效率；同时，还负责收集节点与周围环境的信息，保持与全局负载 DNS 的通信，实现整个系统的负载均衡
  * 高速缓存服务器，负责存储大量的网站内容，像一个靠近用户的网站服务器一样响应本地用户的访问请求

### 具体实现

> squid /skwɪd/ n. 鱿鱼, 乌贼

商业化的 CDN 网络是用于服务性质的，高可用性等要求非常高，有专业产品和 CDN 网络解决方案，本文主要从理论角度理解 CDN 的实现过程，并利用已有网络环境和开源软件做实际配置，深刻理解 CDN 的具体工作过程。 

* Linux，开源的免费操作系统
* Bind，Unix/FreeBSD/Linux 等类 unix 平台上非常有名的 DNS 服务程序，其重要特性之一就是根据用户端源地址对同一域名解析不同的 IP 地址
* Squid，Linux 等操作系统上有名的 Cache 引擎，性能较商业 Cache 低

具体的配置流程：

1. 将域名解析（如 www.a.com，地址 202.99.11.120）交给 CDN 运营商，修改 www 主机的 A 记录为 CNAME 记录并指向 CDN 中心服务器 cache.cdn.com 。

   在 /var/named/linuxaid.com.cn 域名解析记录中，由：

   ```
   www             IN      A       202.99.11.120
   ```

   改为：

   ```
   www             IN      CNAME   cache.cdn.com.
   ```

2. CDN 运营商的中心/全局负载均衡 DNS 服务器，需要把 CNAME 记录根据策略解析出 IP 地址，一般是就近访问的 Cache 地址。

   使用 Bind 9 的 sortlist 选项实现根据用户 IP 地址返回最近的节点 IP 地址，具体的过程为：

   1）为 cache.cdn.com 设置多个A记录，/var/named/cdn.com 的内容如下：

   ```
   $TTL 3600
   @       IN      SOA             ns.cdn.com.     root.ns.cdn.com. (
                     2002090201      ;Serial num
                     10800           ;Refresh after 3 hours
                     3600            ;Retry
                     604800          ;Expire
                     1800            ;Time to live
                     )
           IN      NS              ns
   www     IN      A               210.33.21.168
   ns      IN      A               202.96.128.68
   cache   IN      A               202.93.22.13    ;有多少个CACHE地址
   cache   IN      A               210.21.30.90    ;就有多少个CACHE的A记录
   cache   IN      A               211.99.13.47
   ```

   2）/etc/named.conf 中的内容为：

   ```
   options {
       directory "/var/named";
         sortlist {
   		  #这一段表示当在本地执行查询时
   		  #将按照202.93.22.13,210.21.30.90,211.99.13.47的顺序返回地址
             { localhost;
                 { localnets;
                     202.93.22.13;
                     { 210.21.30.90; 211.99.13.47; };
                 };
             };
             
   		  #这一段表示当在202/8地址段进行DNS查询时
   		  #将按照202.93.22.13,210.21.30.90,211.99.13.47的顺序返回地址
             { 202/8;
                 { 202.93.22.13;
                     { 210.21.30.90; 211.99.13.47; };
                 };
             };
             
   		  #这一段表示当在211/8地址段进行DNS查询时
   		  #将按照211.99.13.47,202.93.22.13,210.21.30.90的顺序返回地址，
   		  #也就是211.99.13.47是最靠近查询地点的节点
             { 211/8;
                 { 211.99.13.47;
                     { 202.93.22.13; 210.21.30.90; };
                 };
             };
             { 61/8;
                 { 202.93.22.13;
                     { 210.21.30.90; 211.99.13.47; };
                 };
             };
         };
   };
   zone "." {
         type hint;
       file "root.cache";
   };
   zone "localhost" {
         type master;
         file "localhost";
   };
   zone "cdn.com" {
       type master;
         file "cdn.com";
   };
   ```

3. Cache 在 CDN 网络中，如果工作在服务器加速模式，因为配置里已经写明加速服务器的 url，所以 Cache 直接匹配用户请求，到源服务器获得内容并缓存供下次使用；如果 Cache 工作在客户端加速模式，Cache 需要知道源服务器的 IP 地址，所以 CDN 网络维护和运行一个供 Cache 使用的 DNS 服务器，解析域名的真实 IP地址，如 202.99.11.120 ，各域名的解析记录与未加入 CDN 网络之前一样。

   工作在 CDN 网络中缓存服务器必须工作在透明方式，对于 Squid 来说，需要设置以下参数：

   ```
   httpd_accel_host virtual
   httpd_accel_port 80
   httpd_accel_with_proxy on
   httpd_accel_uses_host_header on
   ```

### 参考

* https://my.oschina.net/pooz/blog/95654
* https://zh.wikipedia.org/wiki/%E5%85%A7%E5%AE%B9%E5%82%B3%E9%81%9E%E7%B6%B2%E8%B7%AF


